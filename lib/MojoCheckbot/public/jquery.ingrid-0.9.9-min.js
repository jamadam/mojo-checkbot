jQuery.fn.ingrid=function(o){var cfg={saveState:false,savedStateLoad:false,initialLoad:false,preselect:false,colWidths:[225,225,225,225],minColWidth:20,headerHeight:30,headerClass:'grid-header-bg',resizableCols:true,gridClass:'datagrid',rowClasses:[],colClasses:[],rowHoverClass:'grid-row-hover',rowSelection:true,rowSelectedClass:'grid-row-sel',onRowSelect:function(tr,selected){},sorting:true,colSortParams:[],sortAscParam:'ASC',sortDescParam:'DESC',sortedCol:'col1',sortedColDir:'DESC',sortDefaultDir:'ASC',sortAscClass:'grid-sort-asc',sortDescClass:'grid-sort-desc',sortNoneClass:'grid-sort-none',unsortableCols:[],p_id:null,paging:true,pageNumber:1,pageSaved:true,recordsPerPage:0,totalRecords:0,pageToolbarHeight:25,pageToolbarClass:'grid-page-toolbar',pageStartClass:'grid-page-start',pagePrevClass:'grid-page-prev',pageInfoClass:'grid-page-info',pageInputClass:'grid-page-input',pageNextClass:'grid-page-next',pageEndClass:'grid-page-end',pageLoadingClass:'grid-page-loading',pageLoadingDoneClass:'grid-page-loading-done',pageViewingRecordsInfoClass:'grid-page-viewing-records-info',pageChanged:function(p){},url:'remote.php',type:'GET',dataType:'html',extraParams:{},loadingClass:'grid-loading',loadingHtml:'<div> </div>',onLoadStart:function(){},onLoadSuccess:function(data){},onLoadComplete:function(){},resizeHandleHtml:'',resizeHandleClass:'grid-col-resize',scrollbarW:0,columnIDAttr:'_colid',ingridIDPrefix:'_ingrid',cookieExpiresDays:1,cookiePath:'/',minHeight:100,resizableGrid:true,dragDropCols:true,sortType:'server|client|none',isSortableCol:function(colIndex){if(cfg.unsortableCols.length==0||jQuery.inArray(colIndex,cfg.unsortableCols)==-1){return true;}
return false;}};jQuery.extend(cfg,o);var total_width=0;for(i=0;i<cfg.colWidths.length;i++){total_width+=cfg.colWidths[i];}
var cols=new Array();var h=this.find('thead').height(cfg.headerHeight).addClass(cfg.headerClass).height(cfg.headerHeight).extend({cols:cols});h.find('th').each(function(i){jQuery(this).width(cfg.colWidths[i]);var col_label=jQuery('<div />').html(jQuery(this).html()).css("float","left").css("display","block").css('-moz-user-select','none').css('-khtml-user-select','none').css('user-select','none').attr('unselectable','on');if(cfg.sorting&&cfg.isSortableCol(i)){var key=cfg.colSortParams[i]?cfg.colSortParams[i]:i;var cls=(key==cfg.sortedCol||i==cfg.sortedCol)?(cfg.sortedColDir==cfg.sortAscParam?cfg.sortAscClass:cfg.sortDescClass):(cfg.sortNoneClass);col_label.addClass(cls).click(function(){var dir=col_label.hasClass(cfg.sortNoneClass)?cfg.sortDefaultDir:(col_label.hasClass(cfg.sortAscClass)?cfg.sortDescParam:cfg.sortAscParam);var params={sort:key,dir:dir};if(p)jQuery.extend(params,{page:p.getPage()});g.load(params,function(){var cls=col_label.hasClass(cfg.sortNoneClass)?(cfg.sortDefaultDir==cfg.sortAscParam?cfg.sortAscClass:cfg.sortDescClass):(col_label.hasClass(cfg.sortAscClass)?cfg.sortDescClass:cfg.sortAscClass);var i2=0;g.getHeaders(function(col){col.find('div:first').each(function(){if(cfg.isSortableCol(i2++))
jQuery(this).addClass(cfg.sortNoneClass).removeClass(cfg.sortAscClass).removeClass(cfg.sortDescClass);});});col_label.removeClass(cfg.sortAscClass).removeClass(cfg.sortDescClass).addClass(cls).removeClass(cfg.sortNoneClass);});});}
jQuery(this).html(col_label);jQuery(this).bind('resizeColumn',{col_num:i},function(e,w){oldtotalw=g.width();oldw=jQuery(this).width();d=(w-oldw);jQuery(this).width(w);i=0;while(h.height()>cfg.headerHeight){jQuery(this).width(w+=5);d=(w-oldw);if(++i==50)break;}
g.width(oldtotalw+d);g.resize();g.getColumn(e.data.col_num).each(function(){jQuery(this).width(w);});});if(cfg.resizableCols){var handle=jQuery('<div />').html(cfg.resizeHandleHtml==''?'-':cfg.resizeHandleHtml).addClass(cfg.resizeHandleClass);handle.bind('mousedown',function(e){var th=jQuery(this).parent();pos=jQuery(this).offset();var left=jQuery(window).scrollLeft()+e.clientX;z.resizeStart(th,left,jQuery(this));});jQuery(this).append(handle);}});var b=this.find('tbody').addClass(cfg.gridClass);if(cfg.resizableCols){var z_sel='vertical-resize-divider'+new Date().getTime();var z=jQuery('<div id="'+z_sel+'"></div>').css({backgroundColor:'#ababab',width:'4px',position:'absolute',zIndex:'10',display:'block',opacity:'0.5'}).extend({resizeStart:function(th,eventX,resizerobj){jQuery("body").css('-webkit-user-select','none').css('-khtml-user-select','none').css('-moz-user-select','none').css('-o-user-select','none').css('user-select','none');var pos=th.offset();jQuery(this).show().css({top:pos.top,left:eventX,height:(cfg.headerHeight+b.height())});jQuery('body').bind('mousemove',{col:th},function(e){var th=e.data.col;var pos=th.offset();var col_w=jQuery(window).scrollLeft()+e.clientX-pos.left;if(col_w>cfg.minColWidth){jQuery('#'+z_sel).css('left',jQuery(window).scrollLeft()+e.clientX);}});jQuery('body').bind('mouseup',{col:th},function(e){jQuery("body").css('-webkit-user-select','auto').css('-khtml-user-select','normal').css('-moz-user-select','normal').css('-o-user-select','normal').css('user-select','normal');jQuery(this).unbind('mousemove').unbind('mouseup');jQuery('#'+z_sel).hide();var th=e.data.col;var pos=th.offset();var col_w=jQuery(window).scrollLeft()+e.clientX-pos.left;if(col_w>cfg.minColWidth){th.trigger('resizeColumn',[col_w]);}else{th.trigger('resizeColumn',[cfg.minColWidth]);}});}});}
if(cfg.paging){var totr=cfg.recordsPerPage>0?cfg.recordsPerPage:b.find('tr').length;if(cfg.totalRecords>0){var totp=Math.ceil(cfg.totalRecords/totr);}
var p;var pv;var pb1;var pb2;var pb3;var pb4;var pload;var pfld;var pinfo;var pform;if(cfg.p_id!=null){p=jQuery('#'+cfg.p_id);pv=jQuery('.'+cfg.pageViewingRecordsInfoClass);pb1=jQuery('.'+cfg.pageStartClass);pb2=jQuery('.'+cfg.pagePrevClass);pb3=jQuery('.'+cfg.pageNextClass);pb4=jQuery('.'+cfg.pageEndClass);if(!cfg.totalRecords>0){pb4.remove();}
pload=jQuery('.'+cfg.pageLoadingClass);pfld=jQuery('.'+cfg.pageInputClass);pinfo=jQuery('.'+cfg.pageInfoClass);pform=jQuery('#'+cfg.p_id+" form");;}
else{p=jQuery('<div />').addClass(cfg.pageToolbarClass).height(cfg.pageToolbarHeight);pv=jQuery('<div />').addClass(cfg.pageViewingRecordsInfoClass);pb1=jQuery('<a href="#bottom">«</a>').addClass(cfg.pageStartClass);pb2=jQuery('<a href="#bottom"><</a>').addClass(cfg.pagePrevClass);pb3=jQuery('<a href="#bottom">></a>').addClass(cfg.pageNextClass);if(cfg.totalRecords>0){pb4=jQuery('<a href="#bottom">»</a>').addClass(cfg.pageEndClass);}
pload=jQuery('<div />').addClass(cfg.pageLoadingClass);pfld=jQuery('<input type="text" value="'+cfg.pageNumber+'"/>').addClass(cfg.pageInputClass);pinfo=jQuery('<div />').addClass(cfg.pageInfoClass).append(pfld);pform=jQuery('<form></form>').append(pinfo);p.append(pb1).append(pb2).append(pform).append(pb3).append(pb4).append(pload).append(pv);}
p.extend({setPage:function(p){var input=this.find('input.'+cfg.pageInputClass);pload.removeClass(cfg.pageLoadingDoneClass);g.load({page:p},function(){input.val(p);if(cfg.totalRecords>0){var totr=b.find('tr').length;pv.updateViewInfo(totr,p);if(cfg.pageChanged){cfg.pageChanged(p);}}
pload.addClass(cfg.pageLoadingDoneClass);});return this;},getPage:function(){var page=Number(this.find('input.'+cfg.pageInputClass).val());return page;}});pv.extend({updateViewInfo:function(loaded_rows,page){var _start=((cfg.recordsPerPage*(page-1)+1));if(cfg.totalRecords>0){_end=((cfg.recordsPerPage*page)>cfg.totalRecords?cfg.totalRecords:cfg.recordsPerPage*page);this.html('Viewing Rows '+_start+' - '+_end+' of '+cfg.totalRecords);}else{_end=_start+cfg.recordsPerPage;this.html('Viewing Rows '+_start+' - '+_end);}
return this;}});pv.updateViewInfo(totr,cfg.pageNumber);pb1.click(function(){p.setPage(1);});pb2.click(function(){var _p=p.getPage();if(_p>1){_p--;p.setPage(_p);}});function nextPage(){var _p=p.getPage();_p++;if(totp){if(_p<=totp){p.setPage(_p);}}else{p.setPage(_p);}}
pb3.click(nextPage);pload.addClass(cfg.pageLoadingDoneClass);pfld=jQuery('<input type="text" value="'+cfg.pageNumber+'"/>').addClass(cfg.pageInputClass);pform.submit(function(){var _p=parseInt(p.getPage());if(_p>0){if(totp){if(_p<=totp)
p.setPage(_p);else
p.setPage(totp);}else if(_p>0){p.setPage(_p);}}else{alert('Please enter a valid page number.');}
return false;});if(cfg.totalRecords>0){pinfo.html('Page '+pinfo.html()+' of '+totp);pb4.click(function(){var _p=p.getPage();_p++;if(totp){if(_p<=totp)p.setPage(totp);}});}else{pinfo.html('Page '+pinfo.html());}}
var g=jQuery('<table cellpadding="0" cellspacing="0"></table>').width(total_width).addClass(cfg.gridClass).append(h).append(b).extend({h:h,b:b});if(cfg.paging){if(total_width>400){p.width(total_width);}
g.extend({p:p});}
if(cfg.resizableCols){g.extend({z:z});}
var gap=jQuery('<div />').width(cfg.scrollbarW).addClass(cfg.headerClass).height(cfg.headerHeight).css({position:'absolute',zIndex:'0'}).appendTo(g);var modalmask=jQuery('<div />').html(cfg.loadingHtml).addClass(cfg.loadingClass).css({position:'absolute',zIndex:'1000'}).appendTo(g).hide();g.extend({selected_ids:[],load:function(params,cb){cfg.onLoadStart();var data=jQuery.extend(cfg.extraParams,params);data.rand=Math.random();modalmask.width(b.width()).height(b.height()).show();if(typeof(pload)!='undefined')
pload.addClass(cfg.pageLoadingClass);g.saveSelectedRows();jQuery.ajax({type:cfg.type.toUpperCase(),url:cfg.url,data:data,success:function(result){cfg.onLoadSuccess(result);if(result==""){g.clear();if(cfg.paging)
pv.html("An error has occured.");alert("An error has occured.");return;}
if(cfg.dataType=='json'){var rows=eval('('+result+')');alert('json = '+rows);}
if(cfg.dataType=='html'){var tmp=jQuery("<div />").html(result);var $tbl=tmp.find("tbody");var row=$tbl.find('tr:first');if(jQuery(row).find('td').length==cfg.colWidths.length){jQuery(row).find('td').each(function(i){jQuery(this).width(g.getHeader(i).css('width'));});b.html($tbl.html());g.initStylesAndWidths();var totr=b.find('tr').length;if(!data.page){data.page=1;}
if(cfg.paging){pv.updateViewInfo(totr,data.page);pb3.click(nextPage);}
g.saveState(data);}else if(row.length<1){g.clear();if(cfg.paging){pv.html("No result found.");pb3.unbind("click");}
alert("No result found.");}else{g.clear();if(cfg.paging){pv.html("Error: inconsistent result.");}
alert("Error: inconsistent result");}}
if(cb)cb();},error:function(req,status,ex){if(cfg.paging)
pv.html("An error occured.");alert("An error occured");},complete:function(){modalmask.hide();if(typeof(pload)!='undefined'){pload.removeClass(cfg.pageLoadingClass);pload.addClass(cfg.pageLoadingDoneClass);}
cfg.onLoadComplete();}});return this;},reload:function(){g.load();},clear:function(){modalmask.hide();b.html('<tr><td colspan="'+cols.length+'"></td></tr>');},getState:function(){var props={url:'nothing'};return props;},saveState:function(data){if(jQuery.cookie&&cfg.saveState){var g_id=this.attr('id');var param_str='page='+data.page+',sort='+data.sort+',dir='+data.dir;jQuery.cookie(g_id,param_str,{expires:cfg.cookieExpiresDays,path:cfg.cookiePath});}},saveSelectedRows:function(){if(jQuery.cookie){var row_ids=g.selected_ids;if(row_ids.length>0)
jQuery.cookie(this.attr('id')+'_rows',row_ids.join(','),{expires:cfg.cookieExpiresDays,path:cfg.cookiePath});}},getHeaders:function(cb){var ths=this.find('th');if(cb){ths.each(function(){cb(jQuery(this));});return this;}else{return ths;}},getHeader:function(i,cb){var th=this.find('th').slice(i,i+1);if(cb){cb(jQuery(this));return this;}else{return th;}},getColumn:function(i,cb){var tds=this.find("tbody td["+cfg.columnIDAttr+"='"+i+"']");if(cb){tds.each(function(){cb(jQuery(this));});return this;}else{return tds;}},getRows:function(cb){var trs=this.find("tbody tr");if(cb){trs.each(function(){cb(jQuery(this));});return this;}else{return trs;}},getSelectedRows:function(){return this.find("tbody tr[_selected='true']");},unSelectAll:function(){g.getSelectedRows().each(function(){jQuery(this).attr("_selected","true");jQuery(this).click();});},selectAll:function(){this.find("tbody tr").each(function(){jQuery(this).attr("_selected","false");jQuery(this).click();});},getSavedRowIds:function(){var row_ids=[];if(jQuery.cookie){var str_ids=jQuery.cookie(this.attr('id')+'_rows');if(str_ids)row_ids=str_ids.split(',');}
return row_ids;},getSelectedIds:function(){return g.selected_ids;},removeSelectedId:function(id){sid=String(id);var idx=jQuery.inArray(sid,g.selected_ids);if(idx!=-1){g.selected_ids.splice(idx,1);}},resize:function(){var outer_w=g.width();b.width(outer_w);if(cfg.paging&&outer_w>400)p.width(outer_w);if(gap){var pos=h.offset();gap.css('left',outer_w-cfg.scrollbarW+pos.left).css('top',pos.top);}},initStylesAndWidths:function(){var colWidths=new Array();this.getHeaders().each(function(i){colWidths[i]=jQuery(this).css('width');});if(cfg.preselect)
g.selected_ids=g.getSavedRowIds();this.getRows().each(function(r){if(cfg.rowClasses.length>0){var cursor=(r==0?0:r%cfg.rowClasses.length);if(cfg.rowClasses[cursor]!=''){jQuery(this).addClass(cfg.rowClasses[cursor]);}
if(cfg.rowHoverClass!=''){jQuery(this).hover(function(){if(jQuery(this).attr('_selected')!='true')
jQuery(this).removeClass(cfg.rowClasses[cursor]).addClass(cfg.rowHoverClass);},function(){if(jQuery(this).attr('_selected')!='true')
jQuery(this).removeClass(cfg.rowHoverClass).addClass(cfg.rowClasses[cursor]);});}}
jQuery(this).find('td').each(function(i){jQuery(this).attr(cfg.columnIDAttr,i).width(colWidths[i]).css('overflow','hidden');if(cfg.colClasses.length>0){if(cfg.colClasses[i]!=''){jQuery(this).addClass(cfg.colClasses[i]);}}});if(cfg.rowSelection==true){jQuery(this).click(function(){isAlreadySelected=jQuery(this).attr('id')!=undefined&&jQuery.inArray(jQuery(this).attr('id'),g.selected_ids)!=-1;if(jQuery(this).attr('_selected')&&jQuery(this).attr('_selected')=='true'){jQuery(this).attr('_selected','false').removeClass(cfg.rowSelectedClass);if(isAlreadySelected)
g.removeSelectedId(jQuery(this).attr('id'));}else{jQuery(this).attr('_selected','true').addClass(cfg.rowSelectedClass);if(!isAlreadySelected)
g.selected_ids.push(jQuery(this).attr('id'));}
cfg.onRowSelect(this,(jQuery(this).attr('_selected')=='true'));});if(jQuery(this).attr('id')!=undefined&&jQuery.inArray(jQuery(this).attr('id'),g.selected_ids)!=-1){jQuery(this).attr('_selected','true').addClass(cfg.rowSelectedClass);if(jQuery(this).attr('id')==undefined||jQuery.inArray(jQuery(this).attr('id'),g.selected_ids)==-1)
g.selected_ids.push(jQuery(this).attr('id'));cfg.onRowSelect(this,true);}}});}});return this.each(function(tblIter){var g_id=cfg.ingridIDPrefix+'_'+jQuery(this).attr('id')+'_'+tblIter;g.attr('id',g_id);var ok=jQuery("<div />").append(g[0]);if(cfg.paging&&cfg.p_id==null)
ok.append(p);if(cfg.resizableCols)
ok.append(z.hide());jQuery(this).replaceWith(ok);g.initStylesAndWidths();g.resize();modalmask.width(h.width()+cfg.scrollbarW).height(b.height()).css({top:b.offset().top,left:b.offset().left});if(cfg.savedStateLoad&&jQuery.cookie){var param_str=jQuery.cookie(g_id);if(!param_str){g.load();cfg.initialLoad=false;}else{var pairs=param_str.split(',');var params={};var hash=[];for(i=0;i<pairs.length;i++){var prop=pairs[i].split('=');hash[prop[0]]=prop[1];}
if(hash['page'].toLowerCase()!='undefined'&&cfg.paging&&cfg.pageSaved){params.page=hash['page'];p.find('input.'+cfg.pageInputClass).val(params.page);}
if(hash['sort'].toLowerCase()!='undefined'&&hash['dir'].toLowerCase()!='undefined'){params.sort=hash['sort'];params.dir=hash['dir'];var colid=params.sort;if(cfg.colSortParams.length>0){for(i=0;i<cfg.colSortParams;i++){if(cfg.colSortParams[i]==params.sort){colid=i;break;}}}
var i2=0;g.getHeaders(function(col){col.find('div:first').each(function(){if(cfg.isSortableCol(i2++))
g.getHeaders(function(th){jQuery(this).addClass(cfg.sortNoneClass).removeClass(cfg.sortAscClass).removeClass(cfg.sortDescClass);});});});g.getHeader(parseInt(colid)).find('div:first').addClass(cfg.sortNoneClass).removeClass(cfg.sortAscClass).removeClass(cfg.sortDescClass).addClass(params.dir==cfg.sortAscParam?cfg.sortAscClass:cfg.sortDescClass).removeClass(cfg.sortNoneClass);}
if(params.page||params.sort||params.dir){g.load(params);cfg.initialLoad=false;}}}
if(cfg.initialLoad){g.load();}}).extend({cfg:cfg,g:g});};